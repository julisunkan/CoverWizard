<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDP Cover Creator</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Professional KDP-compliant wraparound book cover generator with offline support">
    <meta name="theme-color" content="#007bff">
    <meta name="background-color" content="#1a1a1a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="KDP Cover Creator">
    <meta name="application-name" content="KDP Cover Creator">
    <meta name="msapplication-TileColor" content="#007bff">
    <meta name="msapplication-navbutton-color" content="#007bff">
    
    <!-- Additional PWA meta tags for better fullscreen experience -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
    <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512x512.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
    <link rel="apple-touch-icon" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
    <link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512x512.png') }}">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    
    <!-- Stylesheets -->
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container py-5">
        <!-- Header -->
        <div class="row mb-5">
            <div class="col-12 text-center">
                <h1 class="display-4 mb-3">
                    <i class="fas fa-book text-primary me-3"></i>
                    KDP Cover Creator
                </h1>
                <p class="lead text-muted">Generate professional KDP-compliant wraparound book covers with proper bleed margins</p>
            </div>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Main Form -->
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-magic me-2"></i>
                            Create Your Book Cover
                        </h3>
                    </div>
                    <div class="card-body">
                        <form method="POST" enctype="multipart/form-data" id="coverForm">
                            
                            <!-- Image Upload Section -->
                            <div class="mb-4">
                                <h5 class="mb-3">
                                    <i class="fas fa-image me-2 text-primary"></i>
                                    Cover Images
                                </h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="front_cover_image" class="form-label">Front Cover Image *</label>
                                        <input type="file" class="form-control" id="front_cover_image" name="front_cover_image" 
                                               accept="image/*" required>
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Main cover image for the front
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="back_cover_image" class="form-label">Back Cover Image</label>
                                        <input type="file" class="form-control" id="back_cover_image" name="back_cover_image" 
                                               accept="image/*">
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Optional back cover image
                                        </div>
                                    </div>
                                </div>
                                <div class="form-text mt-2">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Supported formats: PNG, JPG, JPEG, GIF, BMP, TIFF. Maximum size: 16MB each
                                    <br>
                                    <i class="fas fa-magic me-1 text-primary"></i>
                                    Images are automatically enhanced and extended to fit cover dimensions professionally
                                </div>
                            </div>

                            <hr class="my-4">

                            <!-- Book Information -->
                            <div class="mb-4">
                                <h5 class="mb-3">
                                    <i class="fas fa-info-circle me-2 text-primary"></i>
                                    Book Information
                                </h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="title" class="form-label">Book Title *</label>
                                        <input type="text" class="form-control" id="title" name="title" required
                                               placeholder="Enter your book title">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="subtitle" class="form-label">Subtitle</label>
                                        <input type="text" class="form-control" id="subtitle" name="subtitle"
                                               placeholder="Enter subtitle (optional)">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="author" class="form-label">Author Name *</label>
                                        <input type="text" class="form-control" id="author" name="author" required
                                               placeholder="Enter author name">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="spine_text" class="form-label">Spine Text</label>
                                        <input type="text" class="form-control" id="spine_text" name="spine_text"
                                               placeholder="Text for book spine (optional)">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12 mb-3">
                                        <label for="back_cover_text" class="form-label">Back Cover Description</label>
                                        <textarea class="form-control" id="back_cover_text" name="back_cover_text" rows="4"
                                                  placeholder="Book description, author bio, or other back cover text (optional)"></textarea>
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>
                                            This text will be overlaid on the back cover image
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4">

                            <!-- Book Specifications -->
                            <div class="mb-4">
                                <h5 class="mb-3">
                                    <i class="fas fa-ruler me-2 text-primary"></i>
                                    Book Specifications
                                </h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="trim_size" class="form-label">Trim Size</label>
                                        <select class="form-select" id="trim_size" name="trim_size">
                                            <option value="6x9" selected>6" × 9" (Most Popular)</option>
                                            <option value="5x8">5" × 8"</option>
                                            <option value="5.25x8">5.25" × 8"</option>
                                            <option value="5.5x8.5">5.5" × 8.5"</option>
                                            <option value="6.14x9.21">6.14" × 9.21" (A5)</option>
                                            <option value="6.69x9.61">6.69" × 9.61"</option>
                                            <option value="7x10">7" × 10"</option>
                                            <option value="7.44x9.69">7.44" × 9.69" (B5)</option>
                                            <option value="7.5x9.25">7.5" × 9.25"</option>
                                            <option value="8x10">8" × 10"</option>
                                            <option value="8.25x6">8.25" × 6"</option>
                                            <option value="8.25x8.25">8.25" × 8.25"</option>
                                            <option value="8.5x8.5">8.5" × 8.5"</option>
                                            <option value="8.5x11">8.5" × 11"</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="page_count" class="form-label">Page Count</label>
                                        <input type="number" class="form-control" id="page_count" name="page_count" 
                                               value="100" min="24" max="800" required>
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Used to calculate spine width
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4">

                            <!-- Text Styling -->
                            <div class="mb-4">
                                <h5 class="mb-3">
                                    <i class="fas fa-font me-2 text-primary"></i>
                                    Text Styling
                                </h5>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="title_font_size" class="form-label">Title Font Size</label>
                                        <input type="range" class="form-range" id="title_font_size" name="title_font_size" 
                                               min="20" max="80" value="48" oninput="updateFontSizeDisplay('title')">
                                        <div class="d-flex justify-content-between">
                                            <small class="text-muted">20px</small>
                                            <span id="titleFontSize" class="badge bg-secondary">48px</span>
                                            <small class="text-muted">80px</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="author_font_size" class="form-label">Author Font Size</label>
                                        <input type="range" class="form-range" id="author_font_size" name="author_font_size" 
                                               min="12" max="40" value="24" oninput="updateFontSizeDisplay('author')">
                                        <div class="d-flex justify-content-between">
                                            <small class="text-muted">12px</small>
                                            <span id="authorFontSize" class="badge bg-secondary">24px</span>
                                            <small class="text-muted">40px</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="text_color" class="form-label">Text Color</label>
                                        <input type="color" class="form-control form-control-color" id="text_color" 
                                               name="text_color" value="#FFFFFF" title="Choose text color">
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4">

                            <!-- Submit Button -->
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg" id="generateBtn">
                                    <i class="fas fa-cogs me-2"></i>
                                    Generate KDP Cover
                                </button>
                            </div>

                            <!-- Progress Bar (hidden by default) -->
                            <div class="mt-3" id="progressContainer" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">Generating your cover...</span>
                                    <span class="text-primary fw-bold" id="progressPercent">0%</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" 
                                         id="progressBar" 
                                         style="width: 0%;" 
                                         aria-valuenow="0" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted" id="progressStatus">Preparing files...</small>
                                </div>
                            </div>

                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Information Section -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info">
                        <h5 class="card-title mb-0 text-white">
                            <i class="fas fa-lightbulb me-2"></i>
                            KDP Cover Requirements
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-check-circle text-success me-2"></i>What this tool provides:</h6>
                                <ul class="list-unstyled ms-3">
                                    <li><i class="fas fa-arrow-right text-muted me-2"></i>Complete wraparound cover (front + spine + back)</li>
                                    <li><i class="fas fa-arrow-right text-muted me-2"></i>Intelligent image extension and enhancement</li>
                                    <li><i class="fas fa-arrow-right text-muted me-2"></i>0.125" bleed margins on all sides</li>
                                    <li><i class="fas fa-arrow-right text-muted me-2"></i>Automatic spine width calculation</li>
                                    <li><i class="fas fa-arrow-right text-muted me-2"></i>300 DPI high-resolution PDF output</li>
                                    <li><i class="fas fa-arrow-right text-muted me-2"></i>Safe text area positioning</li>
                                    <li><i class="fas fa-arrow-right text-muted me-2"></i>KDP-compliant dimensions</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-info-circle text-info me-2"></i>Tips for best results:</h6>
                                <ul class="list-unstyled ms-3">
                                    <li><i class="fas fa-arrow-right text-muted me-2"></i>Any image size works - automatic enhancement applied</li>
                                    <li><i class="fas fa-arrow-right text-muted me-2"></i>Choose contrasting text colors for readability</li>
                                    <li><i class="fas fa-arrow-right text-muted me-2"></i>Upload highest quality images available</li>
                                    <li><i class="fas fa-arrow-right text-muted me-2"></i>Test your cover at thumbnail size</li>
                                    <li><i class="fas fa-arrow-right text-muted me-2"></i>Add descriptive back cover text for better appeal</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Update font size display
        function updateFontSizeDisplay(type) {
            const slider = document.getElementById(type + '_font_size');
            const display = document.getElementById(type + 'FontSize');
            display.textContent = slider.value + 'px';
        }

        // Progress tracking variables
        let progressInterval;
        let currentProgress = 0;
        let progressPhases = [
            { end: 15, message: "Validating files..." },
            { end: 30, message: "Processing images..." },
            { end: 50, message: "Calculating dimensions..." },
            { end: 70, message: "Generating cover layout..." },
            { end: 85, message: "Creating PDF..." },
            { end: 95, message: "Finalizing cover..." },
            { end: 100, message: "Download starting..." }
        ];

        // Form submission handling with progress tracking
        document.getElementById('coverForm').addEventListener('submit', function(e) {
            const submitBtn = document.getElementById('generateBtn');
            const originalText = submitBtn.innerHTML;
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            const progressStatus = document.getElementById('progressStatus');
            
            // Check if online
            if (!navigator.onLine) {
                e.preventDefault();
                // Silent handling - save form data and show subtle notification instead of alert
                saveFormDataOffline();
                showOfflineSubmissionNotification();
                return false;
            }
            
            // Show progress bar and update button
            progressContainer.style.display = 'block';
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
            submitBtn.disabled = true;
            
            // Reset progress
            currentProgress = 0;
            progressBar.style.width = '0%';
            progressPercent.textContent = '0%';
            progressStatus.textContent = 'Preparing files...';
            
            // Save form data for offline recovery
            saveFormDataOffline();
            
            // Start progress animation
            startProgressAnimation();
            
            // Create a hidden form to track the actual submission
            const form = e.target;
            const formData = new FormData(form);
            
            // Prevent default form submission
            e.preventDefault();
            
            // Submit form using fetch to track download
            fetch(form.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    // Update progress to 95% when response is ready
                    updateProgress(95);
                    return response.blob();
                } else {
                    throw new Error('Cover generation failed');
                }
            })
            .then(blob => {
                // Complete progress and trigger download
                completeProgress();
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                
                // Get filename from form data
                const title = formData.get('title') || 'cover';
                a.download = `${title.replace(/[^a-zA-Z0-9]/g, '_')}_cover.pdf`;
                
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Reset UI after download
                setTimeout(() => {
                    resetProgressUI(submitBtn, originalText, progressContainer);
                    showSuccessMessage();
                }, 1000);
            })
            .catch(error => {
                console.error('Error:', error);
                resetProgressUI(submitBtn, originalText, progressContainer);
                showErrorMessage();
            });
        });

        // Save form data to local storage for offline use
        function saveFormDataOffline() {
            const formData = {
                title: document.getElementById('title').value,
                subtitle: document.getElementById('subtitle').value,
                author: document.getElementById('author').value,
                spine_text: document.getElementById('spine_text').value,
                back_cover_text: document.getElementById('back_cover_text').value,
                page_count: document.getElementById('page_count').value,
                trim_size: document.getElementById('trim_size').value,
                title_font_size: document.getElementById('title_font_size').value,
                author_font_size: document.getElementById('author_font_size').value,
                text_color: document.getElementById('text_color').value,
                timestamp: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('kdp_form_data', JSON.stringify(formData));
                console.log('Form data saved offline');
            } catch (error) {
                console.log('Error saving form data:', error);
            }
        }

        // Load saved form data
        function loadSavedFormData() {
            try {
                const savedData = localStorage.getItem('kdp_form_data');
                if (savedData) {
                    const formData = JSON.parse(savedData);
                    
                    // Restore form values
                    document.getElementById('title').value = formData.title || '';
                    document.getElementById('subtitle').value = formData.subtitle || '';
                    document.getElementById('author').value = formData.author || '';
                    document.getElementById('spine_text').value = formData.spine_text || '';
                    document.getElementById('back_cover_text').value = formData.back_cover_text || '';
                    document.getElementById('page_count').value = formData.page_count || 100;
                    document.getElementById('trim_size').value = formData.trim_size || '6x9';
                    document.getElementById('title_font_size').value = formData.title_font_size || 48;
                    document.getElementById('author_font_size').value = formData.author_font_size || 24;
                    document.getElementById('text_color').value = formData.text_color || '#FFFFFF';
                    
                    // Update font size displays
                    updateFontSizeDisplay('title');
                    updateFontSizeDisplay('author');
                    
                    console.log('Form data restored from offline storage');
                }
            } catch (error) {
                console.log('Error loading saved form data:', error);
            }
        }

        // Auto-save form data as user types
        function setupAutoSave() {
            const formElements = document.querySelectorAll('#coverForm input, #coverForm select, #coverForm textarea');
            formElements.forEach(element => {
                element.addEventListener('input', () => {
                    debounce(saveFormDataOffline, 1000)();
                });
            });
        }

        // Debounce function to limit auto-save frequency
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // File upload validation function
        function validateImageFile(input, fileType) {
            const file = input.files[0];
            if (file) {
                const maxSize = 16 * 1024 * 1024; // 16MB
                if (file.size > maxSize) {
                    alert(`${fileType} file size exceeds 16MB limit. Please choose a smaller file.`);
                    input.value = '';
                    return false;
                }
                
                const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/bmp', 'image/tiff'];
                if (!allowedTypes.includes(file.type)) {
                    alert(`Invalid ${fileType} file type. Please upload a PNG, JPG, JPEG, GIF, BMP, or TIFF file.`);
                    input.value = '';
                    return false;
                }
            }
            return true;
        }

        // Front cover validation
        document.getElementById('front_cover_image').addEventListener('change', function(e) {
            validateImageFile(e.target, 'front cover');
        });

        // Back cover validation
        document.getElementById('back_cover_image').addEventListener('change', function(e) {
            validateImageFile(e.target, 'back cover');
        });

        // PWA Installation and Service Worker
        let deferredPrompt;

        // Listen for install prompt but don't show button (removed per user request)
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Install button functionality removed
        });

        // Handle app installation event
        window.addEventListener('appinstalled', () => {
            console.log('PWA installed successfully');
            deferredPrompt = null;
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/static/sw.js');
                    console.log('Service Worker registered successfully:', registration.scope);
                    
                    // Listen for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        if (newWorker) {
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        // New content available, show update notification
                                        showUpdateNotification();
                                    }
                                }
                            });
                        }
                    });
                } catch (error) {
                    console.log('Service Worker registration failed:', error);
                }
            });
        }

        // Show update notification
        function showUpdateNotification() {
            const notification = document.createElement('div');
            notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
            notification.style.cssText = 'top: 80px; right: 20px; z-index: 1001; max-width: 300px;';
            notification.innerHTML = `
                <i class="fas fa-sync-alt me-2"></i>
                New version available!
                <button type="button" class="btn btn-sm btn-info ms-2" onclick="updateApp()">Update</button>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
        }

        // Update app
        function updateApp() {
            if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
            }
            window.location.reload();
        }

        // Online/Offline status
        function updateOnlineStatus() {
            const statusIndicator = document.getElementById('onlineStatus');
            if (!statusIndicator) {
                const indicator = document.createElement('div');
                indicator.id = 'onlineStatus';
                indicator.className = 'position-fixed';
                indicator.style.cssText = 'bottom: 20px; left: 20px; z-index: 1000;';
                document.body.appendChild(indicator);
            }
            
            const indicator = document.getElementById('onlineStatus');
            if (navigator.onLine) {
                indicator.innerHTML = '<span class="badge bg-success"><i class="fas fa-wifi me-1"></i>Online</span>';
            } else {
                indicator.innerHTML = '<span class="badge bg-warning"><i class="fas fa-wifi-slash me-1"></i>Offline</span>';
            }
        }

        // Monitor online/offline status
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // Initialize status on page load
        updateOnlineStatus();
        
        // Progress animation functions
        function startProgressAnimation() {
            let phaseIndex = 0;
            currentProgress = 0;
            
            progressInterval = setInterval(() => {
                if (phaseIndex < progressPhases.length) {
                    const phase = progressPhases[phaseIndex];
                    const increment = Math.random() * 3 + 1; // Random increment between 1-4
                    
                    currentProgress = Math.min(currentProgress + increment, phase.end);
                    updateProgressUI(currentProgress, phase.message);
                    
                    if (currentProgress >= phase.end) {
                        phaseIndex++;
                    }
                } else {
                    // Stop at 95% until actual download completes
                    clearInterval(progressInterval);
                }
            }, 200 + Math.random() * 300); // Random interval between 200-500ms
        }

        function updateProgress(percent) {
            currentProgress = percent;
            updateProgressUI(percent, percent >= 95 ? 'Download starting...' : progressPhases.find(p => p.end >= percent)?.message || 'Processing...');
        }

        function updateProgressUI(percent, message) {
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            const progressStatus = document.getElementById('progressStatus');
            
            progressBar.style.width = percent + '%';
            progressBar.setAttribute('aria-valuenow', percent);
            progressPercent.textContent = Math.round(percent) + '%';
            progressStatus.textContent = message;
        }

        function completeProgress() {
            clearInterval(progressInterval);
            updateProgressUI(100, 'Download complete!');
            
            // Add success styling
            const progressBar = document.getElementById('progressBar');
            progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
            progressBar.classList.add('bg-success');
        }

        function resetProgressUI(submitBtn, originalText, progressContainer) {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            progressContainer.style.display = 'none';
            
            // Reset progress bar styling
            const progressBar = document.getElementById('progressBar');
            progressBar.classList.add('progress-bar-striped', 'progress-bar-animated');
            progressBar.classList.remove('bg-success', 'bg-danger');
            
            clearInterval(progressInterval);
        }

        function showSuccessMessage() {
            const notification = document.createElement('div');
            notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
            notification.style.cssText = 'top: 20px; left: 50%; transform: translateX(-50%); z-index: 1002; max-width: 400px;';
            notification.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                Cover generated successfully! Your PDF is ready.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        function showErrorMessage() {
            const notification = document.createElement('div');
            notification.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            notification.style.cssText = 'top: 20px; left: 50%; transform: translateX(-50%); z-index: 1002; max-width: 400px;';
            notification.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error generating cover. Please try again.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Initialize offline features when page loads
        window.addEventListener('load', () => {
            loadSavedFormData();
            setupAutoSave();
            
            // Show subtle offline notification if starting offline (only after 2 seconds to avoid flash)
            if (!navigator.onLine) {
                setTimeout(() => {
                    if (!navigator.onLine) {
                        showOfflineNotification();
                    }
                }, 2000);
            }
        });

        // Show offline notification (subtle, no errors)
        function showOfflineNotification() {
            // Remove any existing offline notifications
            const existing = document.querySelector('.offline-notification');
            if (existing) {
                existing.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = 'alert alert-info alert-dismissible fade show position-fixed offline-notification';
            notification.style.cssText = 'top: 20px; left: 50%; transform: translateX(-50%); z-index: 1002; max-width: 400px; opacity: 0.9;';
            notification.innerHTML = `
                <i class="fas fa-cloud-download-alt me-2"></i>
                App ready for offline use. Form data is automatically saved.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // Show offline form submission notification (no error message)
        function showOfflineSubmissionNotification() {
            const notification = document.createElement('div');
            notification.className = 'alert alert-primary alert-dismissible fade show position-fixed';
            notification.style.cssText = 'top: 20px; left: 50%; transform: translateX(-50%); z-index: 1002; max-width: 400px;';
            notification.innerHTML = `
                <i class="fas fa-save me-2"></i>
                Form saved! Will generate cover when connection is restored.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            // Auto-dismiss after 4 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 4000);
        }

        // When coming back online, show reconnected notification
        window.addEventListener('online', () => {
            const notification = document.createElement('div');
            notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
            notification.style.cssText = 'top: 20px; left: 50%; transform: translateX(-50%); z-index: 1002; max-width: 400px;';
            notification.innerHTML = `
                <i class="fas fa-wifi me-2"></i>
                You're back online! Cover generation is now available.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        });
    </script>
</body>
</html>
